<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>example3.utf8</title>

<script src="site_libs/header-attrs-2.4/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SWMM-GI coupling tool</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="example1.html">Exampe 1</a>
</li>
<li>
  <a href="example2.html">Exampe 2</a>
</li>
<li>
  <a href="example3.html">Exampe 3</a>
</li>
<li>
  <a href="example4.html">Exampe 4</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="example-3-adjusting-subcatchment-parameters-after-installing-gis" class="section level2">
<h2>Example 3 Adjusting subcatchment parameters after installing GIs</h2>
<div id="overview" class="section level3">
<h3>1. Overview</h3>
<p>In this example, the function to modify subcatchment parameters after modeling GIs externally is explored. Additional changes to the catchment can be passed to the <code>modify_inp</code> function through the <em>GI_plan</em> variable, where the tibble columns with the names in the format of <em>section_variable</em> are defined. The <em>“section”</em> term corresponds to the name of the tab used in swmm input files, such as the <em>INFILTRATION</em> tab; the infiltration parameters are store under this tab. The <em>“variable”</em> term corresponds to the name of the variable, e.g., <em>“MaxRate”</em> corresponds to the maximum infiltration rate (see the figure below). Thus, the column can be named as <em>“INFILTRATION_MaxRate”</em>, and different values can be assigned to the column to reflect the changes to subcatchment parameters after installing the GIs, that produce outflow as specified in the <em>inflow_path</em> column (see example 1 for more explanations).</p>
<p><img src="example/example3/image/section_variable.png" /></p>
<p>The goal of this example is to show the consequences of changing subcatchment width after modeling bioretention cells and their controlled areas externally.</p>
<p>The catchment studied in this example is the same as in example 2. It has three subcatchments, as shown in the figure below.</p>
<pre class="r"><code># Load toolbox functions
source(&quot;interface_functions.R&quot;)

inp &lt;- read_inp(&quot;./example/example3/raw_catchment.inp&quot;)

# Functions provided in swmmr are used for visualization
sub_sf &lt;- subcatchments_to_sf(inp)
lin_sf &lt;- links_to_sf(inp)
jun_sf &lt;- junctions_to_sf(inp)
rg_sf &lt;- raingages_to_sf(inp)

lab_coord &lt;- sub_sf %&gt;% 
  sf::st_centroid() %&gt;%
  sf::st_coordinates() %&gt;% 
  tibble::as_tibble()

lab_rg_coord &lt;- rg_sf %&gt;% 
  {sf::st_coordinates(.) + 500} %&gt;% # add offset
  tibble::as_tibble()

sub_sf &lt;- dplyr::bind_cols(sub_sf, lab_coord)
rg_sf &lt;- dplyr::bind_cols(rg_sf, lab_rg_coord)

ggplot() + 
  # first plot the subcatchment and color continuously by Area
  geom_sf(data = sub_sf, aes(fill = Perc_Imperv), color = &quot;black&quot;, alpha = 0.8) + 
  scale_fill_gradient(low = &quot;lightgreen&quot;, high = &quot;indianred4&quot;) +
  geom_sf(data = lin_sf, colour = &quot;blue&quot;, size = 1) +
  geom_sf(data = jun_sf, colour = &quot;grey20&quot;, size = 2) +
  geom_label(data = sub_sf, aes(X, Y, label = Name), size = 3) +
  labs(x = &quot;x-axis&quot;,
       y = &quot;y-axis&quot;,
       fill = &quot;Imperviousness\n(%)&quot;) +
  scale_fill_gradient(limits = c(0,100), low = &quot;#009E73&quot;, high = &quot;#D16103&quot;) +
  theme_bw(base_size = 10)</code></pre>
<p><img src="example3_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="evaluate-the-consequences-of-changing-subcatchment-width-and-mannings-n-after-modeling-bioretention-cells-externally." class="section level3">
<h3>2. Evaluate the consequences of changing subcatchment width and Manning’s n after modeling bioretention cells externally.</h3>
<p>Three units of bioretention cells are assumed to be implemented in each subcatchments. The design option 2 in <a href="https://stsfk.github.io/swmm_gi_toolbox/example2.html">example 2</a> is used, which corresponds to the outflow hydrograph stored in file <em>bc2_outflow.txt</em>.</p>
<p>The following code chunk creates multiple tibbles stored in a list. Each tibble corresponds to a bioretention cell implementation strategy, and for each scenario, the subcatchment width of the subcatchments is set to a random value between 30 and 500, and Manning’s n of the impervious areas of the subcatchment is set to a random value between 0.01 and 0.02. Manning’s n is a measure of surface roughness. Multiple random generated strategies are evaluated to assess the consequences of changing these parameters. The information on catchment width is provided in the <em>width_adj</em> column, and on Manning’s n is provided in the <em>SUBAREAS_N-Imperv</em> column.</p>
<pre class="r"><code>set.seed(10)

inflow_path &lt;- paste0(&quot;./example/example3/bc&quot;, 2, &quot;_outflow.txt&quot;)

N = 50 # Number of scenarios
gi_plans &lt;- vector(&quot;list&quot;, 10) # list storing the random GI install plan
for (i in 1:N){
  gi_plans[[i]] &lt;- tibble(
    inflow_path = rep(inflow_path, 9),
    outlet = rep(0, 9),
    subcatchment_name = rep(c(&quot;S1&quot;, &quot;S2&quot;, &quot;S3&quot;), each = 3),
    per_area_rep = rep(0, 9),
    imp_area_rep = rep(0.1, 9),
    width_adj = rep(runif(3, min = 30, max = 500), each = 3),
    `SUBAREAS_N-Imperv` = rep(runif(3, min = 0.01, max = 0.02), each = 3)
  )
}</code></pre>
<p>The scenarios are evaluated using the <code>write_routing_interface_file</code> and <code>modify_inp</code> functions provided by the toolbox and the swmmr functions.</p>
<pre class="r"><code>read_outflow &lt;- function(fpath = &quot;outflow.txt&quot;){
  # Purpose: read simulated outflow hydrograph
  # Input: 
  #    fpath = file path of the simulated outflow, which is defined in the [FILES] tab in SWMM input file
  # Output:
  #    a tibble stores the outflow hydrograph
  
  read_table(fpath, skip = 7) %&gt;%
    transmute(datetime = ymd_hms(paste(Year, Mon, Day, Hr, Min, Sec)),
            flow = FLOW) %&gt;%
    arrange(datetime)
}

# Read the SWMM input file for the original subcatchment
inp &lt;- read_inp(&quot;./example/example3/raw_catchment.inp&quot;)

# Create a list to store the simulated outflow hydrographs
outflows &lt;- vector(&quot;list&quot;, N)
for (i in 1:N){
  
  # create a routing interface file
  gi_plan &lt;- gi_plans[[i]]
  routing_interface_path &lt;- &quot;./example/example3/routing_interface.txt&quot;
  write_routing_interface_file(
    GI_plan = gi_plan, 
    inp = inp, 
    routing_interface_path = routing_interface_path
  )
  
  # modify the object associated with SWMM input file
  new_inp &lt;- modify_inp(
    GI_plan = gi_plan, 
    inp = inp, 
    routing_interface_path = routing_interface_path
  )
  
  # write the new SWMM input file
  new_inp_path &lt;- &quot;./example/example3/test.inp&quot;
  write_inp(new_inp, file = new_inp_path)
  
  # run simulation
  run_swmm(new_inp_path)
  
  # get simulated outflow hydrograph
  outflows[[i]] &lt;- read_outflow() %&gt;%
    mutate(case = i)
}

# join the simulated hydrograph into a single tibble
outflows &lt;- outflows %&gt;%
  bind_rows()</code></pre>
</div>
<div id="assessment-results" class="section level3">
<h3>3. Assessment results</h3>
<p>The following code generates a figure comparing the hydrographs generated in each scenario. The grey lines correspond to the results for each scenario, and the blue line shows the mean values. Considerable variations between different hydrographs can be observed, especially in the predicted peak flows.</p>
<pre class="r"><code># Keep data for relatively high flow periods
data_plot &lt;- outflows %&gt;%
  filter(datetime &lt;= ymd_hm(&quot;2020-06-02 00:00&quot;))

# Get the mean hydrograph of all the scenarios
data_plot2 &lt;- outflows %&gt;%
  filter(datetime &lt;= ymd_hm(&quot;2020-06-02 00:00&quot;)) %&gt;%
  group_by(datetime) %&gt;%
  mutate(mean_flow = mean(flow)) %&gt;%
  ungroup()

# Plotting
ggplot() +
  geom_line(data = data_plot, aes(datetime, flow, group = case), color = &quot;grey50&quot;, size = 0.5) +
  geom_line(data = data_plot2, aes(datetime, mean_flow), color = &quot;blue&quot;, size = 0.8) +
  labs(x = &quot;Time&quot;,
       y = &quot;Flow rate [CFS]&quot;) +
  theme_bw()</code></pre>
<p><img src="example3_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
