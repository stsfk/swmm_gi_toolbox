<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>example2.utf8</title>

<script src="site_libs/header-attrs-2.1/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SWMM-GI coupling tool</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="example1.html">Exampe 1</a>
</li>
<li>
  <a href="example2.html">Exampe 2</a>
</li>
<li>
  <a href="example3.html">Exampe 3</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="example-2-installing-multiple-bioretention-cells-in-different-subcatchments" class="section level2">
<h2>Example 2 Installing multiple bioretention cells in different subcatchments</h2>
<div id="overview" class="section level3">
<h3>1. Overview</h3>
<p>This examples shows the procedure of using the toolbox when there are multiple subcatchments, and multiple green infrastructures (GIs) of different designs are installed in each subcatchment. The data used in this study can be found in <em>example2</em> folder. The simulations are driven by a 60 mm SCS type III 24-hr design storm.</p>
<p>The studied catchment (in <em>raw_catchment.inp</em>) has three subcatchments. The surface area of the them ranges between 0.5 acre to 0.9 acre, and the imperviousness ranges between 40% to 80%. The following code chunk generates a map of the catchment using functions provided by the swmmr package.</p>
<pre class="r"><code># Load toolbox functions
source(&quot;interface_functions.R&quot;)

inp &lt;- read_inp(&quot;./example/example2/raw_catchment.inp&quot;)

# Functions provided in swmmr are used for visulization
sub_sf &lt;- subcatchments_to_sf(inp)
lin_sf &lt;- links_to_sf(inp)
jun_sf &lt;- junctions_to_sf(inp)
rg_sf &lt;- raingages_to_sf(inp)

lab_coord &lt;- sub_sf %&gt;% 
  sf::st_centroid() %&gt;%
  sf::st_coordinates() %&gt;% 
  tibble::as_tibble()

lab_rg_coord &lt;- rg_sf %&gt;% 
  {sf::st_coordinates(.) + 500} %&gt;% # add offset
  tibble::as_tibble()

sub_sf &lt;- dplyr::bind_cols(sub_sf, lab_coord)
rg_sf &lt;- dplyr::bind_cols(rg_sf, lab_rg_coord)

ggplot() + 
  # first plot the subcatchment and colour continously by Area
  geom_sf(data = sub_sf, aes(fill = Perc_Imperv), color = &quot;black&quot;, alpha = 0.8) + 
  scale_fill_gradient(low = &quot;lightgreen&quot;, high = &quot;indianred4&quot;) +
  geom_sf(data = lin_sf, colour = &quot;blue&quot;, size = 1) +
  geom_sf(data = jun_sf, colour = &quot;grey20&quot;, size = 2) +
  geom_label(data = sub_sf, aes(X, Y, label = Name), size = 3) +
  labs(x = &quot;x-axis&quot;,
       y = &quot;y-axis&quot;,
       fill = &quot;Imperviousness\n(%)&quot;) +
  scale_fill_gradient(limits = c(0,100), low = &quot;#009E73&quot;, high = &quot;#D16103&quot;) +
  theme_bw(base_size = 10)</code></pre>
<p><img src="example2_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="outflow-hydrographs-from-bioretention-cells-of-different-designs" class="section level3">
<h3>2. Outflow hydrographs from bioretention cells of different designs</h3>
<p>Three different bioretention cell designs are considered in this study. The main difference is in the bioretention cell’s capature ratio. In each desgin, a bioretention cell is assumed to control 0.1 acre of the imperivous area and its surface area is set to 3.4 %, 6.9 %, or 10.3 % of the controlled area. The outflow hydrographs from the bioretention cells are modeled using SWMM. The input files are named <em>SWMM_bioretention1.inp</em>, <em>SWMM_bioretention2.inp</em>, and <em>SWMM_bioretention3.inp</em>. The following code execute SWMM simulations, and write the simulated hydrographs in to files named <em>bc1_outflow.txt</em>, etc.</p>
<pre class="r"><code>read_outflow &lt;- function(fpath = &quot;outflow.txt&quot;){
  # Purpose: read simulated outflow hydrograph
  # Input: 
  #    fpath = file path of the simulated outflow, which is defined in the [FILES] tabe in SWMM input file
  # Output:
  #    a tibble stores the outflow hydrograph
  
  read_table(fpath, skip = 7) %&gt;%
    transmute(datetime = ymd_hms(paste(Year, Mon, Day, Hr, Min, Sec)),
            flow = FLOW) %&gt;%
    arrange(datetime)
}

# Case 1: bioretention cells occupies 3.4 % of the catchment area
run_swmm(&quot;./example/example2/SWMM_bioretention1.inp&quot;)
bc1_outflow &lt;- read_outflow()
fname = &quot;./example/example2/bc1_outflow.txt&quot;
write_csv(bc1_outflow, path = fname)

# Case 2: bioretention cells occupies 6.9 % of the catchment area
run_swmm(&quot;./example/example2/SWMM_bioretention2.inp&quot;)
bc2_outflow &lt;- read_outflow()
fname = &quot;./example/example2/bc2_outflow.txt&quot;
write_csv(bc2_outflow, path = fname)

# Case 3: bioretention cells occupies 10.3 % of the catchment area
run_swmm(&quot;./example/example2/SWMM_bioretention3.inp&quot;)
bc3_outflow &lt;- read_outflow()
fname = &quot;./example/example2/bc3_outflow.txt&quot;
write_csv(bc3_outflow, path = fname)</code></pre>
<p>The following code chunk produce a figure that compares the outlfow hydrograph generated for each bioretention design. The hydrographs varied considerably because of the modeling methods used for surface bypass flow and underdrain flow. More details on this issue can be found in this <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1752-1688.12637">paper</a>.</p>
<pre class="r"><code># Join the hydrographs into a single tibble
bc1_outflow$case = &quot;BC design 1&quot;
bc2_outflow$case = &quot;BC design 2&quot;
bc3_outflow$case = &quot;BC design 3&quot;

bc_outflow &lt;- bc1_outflow %&gt;%
  bind_rows(bc2_outflow) %&gt;%
  bind_rows(bc3_outflow)

# Ploting
ggplot(bc_outflow, aes(datetime, flow, color = case, linetype = case)) +
  geom_line(size = 0.65) +
  scale_color_manual(values = c(&quot;grey&quot;, &quot;tomato3&quot;, &quot;turquoise3&quot;)) +
  scale_linetype_manual(values = c(&quot;dashed&quot;, &quot;solid&quot;, &quot;dotdash&quot;))+
  labs(x = &quot;Time&quot;,
       y = &quot;Flow rate [CFS]&quot;) +
  theme_classic(base_size = 12) +
  theme(legend.position = c(1,1),
        legend.justification = c(1,1),
        legend.key.width = unit(1.5, &quot;cm&quot;))</code></pre>
<p><img src="example2_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="creating-bioretention-cells-implementation-scenarios" class="section level3">
<h3>3. Creating bioretention cells implementation scenarios</h3>
<p>In this study, three units of bioretention cells are planned for each subcatchment, and the design of them are chosen randomly, i.e., different units of bioretention cells in the same subcatchment can have different designs.</p>
<p>The following code chunk creates a list <code>gi_plans</code> to store the information needed for model coupling. The meaning of the column of the tibbles, such as <em>inflow_path</em> is explaned in the “Example 1” tab. 50 different GI implementation scenarios are randomly genearted, and in each scenario three units of bioretention cells of different designs are randomly choosen for each subcatchment. Each bioretention cell controls an impervious area of 0.1 acre and drains to the same outlet as the subcatchment. The number of scenarios can be changed by setting the value of <em>N</em> in the following code chunk.</p>
<pre class="r"><code>set.seed(10)

inflow_paths &lt;- paste0(&quot;./example/example2/bc&quot;, 1:3, &quot;_outflow.txt&quot;)

N = 50 # Number of scenarios
gi_plans &lt;- vector(&quot;list&quot;, 10) # list storing the random GI install plan
for (i in 1:N){
  gi_plans[[i]] &lt;- tibble(
    inflow_path = sample(inflow_paths, 9, T),
    outlet = rep(0, 9),
    subcatchment_name = rep(c(&quot;S1&quot;, &quot;S2&quot;, &quot;S3&quot;), each = 3),
    per_area_rep = rep(0, 9),
    imp_area_rep = rep(0.1, 9),
    width_adj = rep(0, 9)
  )
}</code></pre>
</div>
<div id="creating-routing-interface-files-modify-swmm-input-file-and-run-simulations" class="section level3">
<h3>4. Creating routing interface files, modify SWMM input file, and run simulations</h3>
<p>The function <code>write_routing_interface_file</code> provided by the toolbox can automatically create routing interface files to store the externally generated inflows that is readable by SWMM. The function <code>modify_inp</code> can modify the SWMM input files to account for the situation that runoffs from a part of the subcatchment are modeled externally. The functions provided by swmmr are used to run SWMM simulations.</p>
<p>The following code chunk dervies outflow hydrograph at the catchment outlet for each bioretention implementation scenario. For each bioretention implementation scenario, <code>write_routing_interface_file</code> function is first called to write SWMM interface file, <code>modify_inp</code> is then called to update the parameters of the catchment. Then <code>write_inp</code> and <code>run_swmm</code> are called to run SWMM simulations. The results are stored in the tibble <code>outflows</code>.</p>
<pre class="r"><code># Read the SWMM input file for the original subcatchment
inp &lt;- read_inp(&quot;./example/example2/raw_catchment.inp&quot;)

# Create a list to store the simulated outflow hydrographs
outflows &lt;- vector(&quot;list&quot;, N)
for (i in 1:N){
  
  # create a routing interface file
  gi_plan &lt;- gi_plans[[i]]
  routing_interface_path &lt;- &quot;./example/example2/routing_interface.txt&quot;
  write_routing_interface_file(
    GI_plan = gi_plan, 
    inp = inp, 
    routing_interface_path = routing_interface_path
  )
  
  # modify the object associated with swmm input file
  new_inp &lt;- modify_inp(
    GI_plan = gi_plan, 
    inp = inp, 
    routing_interface_path = routing_interface_path
  )
  
  # write the new SWMM input file
  new_inp_path &lt;- &quot;./example/example2/test.inp&quot;
  write_inp(new_inp, file = new_inp_path)
  
  # run simulation
  run_swmm(new_inp_path)
  
  # get simulated outflow hydrograph
  outflows[[i]] &lt;- read_outflow() %&gt;%
    mutate(case = i)
}

# join the simulated hydrograph into a single tibble
outflows &lt;- outflows %&gt;%
  bind_rows()</code></pre>
</div>
<div id="evaluate-simulation-results" class="section level3">
<h3>5. Evaluate simulation results</h3>
<p>The following figure shows the simulated hydrographs for all the scenarios, shown as grey lines. The mean flow rate is shown in blue lines. Considerable variations can be observed among different scenarios.</p>
<pre class="r"><code># Keep data for relatively high flow periods
data_plot &lt;- outflows %&gt;%
  filter(datetime &lt;= ymd_hm(&quot;2020-06-02 00:00&quot;))

# Get the mean hydrograph of all the scenarios
data_plot2 &lt;- outflows %&gt;%
  filter(datetime &lt;= ymd_hm(&quot;2020-06-02 00:00&quot;)) %&gt;%
  group_by(datetime) %&gt;%
  mutate(mean_flow = mean(flow)) %&gt;%
  ungroup()

# Ploting
ggplot() +
  geom_line(data = data_plot, aes(datetime, flow, group = case), color = &quot;grey50&quot;, size = 0.5) +
  geom_line(data = data_plot2, aes(datetime, mean_flow), color = &quot;blue&quot;, size = 0.8) +
  labs(x = &quot;Time&quot;,
       y = &quot;Flow rate [CFS]&quot;) +
  theme_bw()</code></pre>
<p><img src="example2_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>This example presents a workflow that multiple GIs are installed in different subcatchment. The two functions <code>write_routing_interface_file</code> and <code>write_routing_interface_file</code> keep track of each outflow hydrograph from GIs and aggregate the outflows drained to the same node of the drainage network before writting them into routing interface files.</p>
<p>The user needs to provide to the following information to the two functions, (1) a list of paths corrspond to the hydrographs, (2) the destinations of the hydrographs, and (3) the name of the subcatchment, which the GIs locates, and (4) the associated changes to the catchment parameter after modeling GIs externally (e.g., changes to the perious area of the subcatchment, changes to the width of the subcatchment, etc.) An example of the required information is provided in <em>exmaple_gi_plan.csv</em>. This file can be created using Microsoft Excel and similar spreadsheet software. This file can be read by the <code>read_GI_plan</code> function provided by the toolbox. Further details can be found in the paper listed in “Example 1” and the “About” section of this documentation.</p>
<pre class="r"><code>write_csv(gi_plans[[1]], path = &quot;./example/example2/exmaple_gi_plan.csv&quot;)</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
